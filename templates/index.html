<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>술달력 웹버전</title>
  <style>
    body {
      margin: 0;
      font-family: "맑은 고딕", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f3f4f6;
      color: #111827;
    }
    .app-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
    }
    .header {
      background-color: #111827;
      color: #f9fafb;
      padding: 12px 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-title {
      font-size: 22px;
      font-weight: bold;
      color: #f87171;
    }
    .header-spacer {
      flex: 1;
    }
    .header button {
      border: none;
      padding: 6px 10px;
      border-radius: 9999px;
      background-color: #374151;
      color: #f9fafb;
      cursor: pointer;
      font-size: 12px;
    }
    .header button:hover {
      background-color: #4b5563;
    }
    .user-input {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #e5e7eb;
      font-size: 12px;
    }
    .user-input input {
      border-radius: 9999px;
      border: none;
      padding: 4px 10px;
      font-size: 12px;
    }

    .calendar-card {
      background-color: #ffffff;
      border-radius: 12px;
      margin-top: 12px;
      padding: 12px 16px 16px;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.1),
                  0 4px 6px -4px rgba(15, 23, 42, 0.1);
    }
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    .calendar-header-title {
      font-weight: bold;
      font-size: 16px;
    }
    .calendar-header button {
      border: none;
      background: #e5e7eb;
      border-radius: 9999px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 12px;
    }
    .calendar-header button:hover {
      background: #d1d5db;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-top: 8px;
      font-size: 12px;
      font-weight: bold;
      color: #6b7280;
    }
    .weekdays div {
      text-align: center;
      padding: 4px 0;
    }
    .weekdays .sat {
      color: #3b82f6;
    }
    .weekdays .sun {
      color: #ef4444;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
      margin-top: 6px;
    }
    .day-cell-outer {
      background-color: #f9fafb;
      border-radius: 10px;
      padding: 2px;
    }
    .day-cell-inner {
      background-color: #f9fafb;
      border-radius: 8px;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      padding: 2px 4px;
      box-sizing: border-box;
      transition: background-color 0.15s ease, box-shadow 0.15s ease;
    }
    .day-cell-inner.today {
      box-shadow: 0 0 0 2px #2563eb;
    }
    .day-number {
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 2px;
    }
    .toggles-container {
      margin-top: 2px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }
    .toggle-line {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .stats-card {
      background-color: #fafafa;
      border-radius: 12px;
      padding: 10px 14px 12px;
      margin-top: 12px;
      border: 1px solid #e5e7eb;
    }
    .stats-title {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .stats-group-title {
      font-size: 13px;
      font-weight: bold;
      margin-top: 6px;
      margin-bottom: 2px;
    }
    .stats-line {
      font-size: 12px;
      margin-left: 4px;
    }

    .tip {
      margin-top: 8px;
      font-size: 11px;
      color: #4b5563;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 헤더 -->
    <div class="header">
      <div class="header-title">술달력 웹버전</div>
      <div class="user-input">
        <span>사용자 이름:</span>
        <input id="username-input" type="text" placeholder="예: 홍길동" />
        <button id="user-apply-btn">적용</button>
      </div>
      <div class="header-spacer"></div>
      <button id="today-btn">오늘로</button>
    </div>

    <!-- 달력 카드 -->
    <div class="calendar-card">
      <div class="calendar-header">
        <button id="prev-month-btn">◀</button>
        <div class="calendar-header-title" id="month-title"></div>
        <button id="next-month-btn">▶</button>
      </div>

      <div class="weekdays">
        <div>월</div>
        <div>화</div>
        <div>수</div>
        <div>목</div>
        <div>금</div>
        <div class="sat">토</div>
        <div class="sun">일</div>
      </div>

      <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <!-- 통계 카드 -->
    <div class="stats-card">
      <div class="stats-title">통계</div>

      <div class="stats-group-title">연속으로 안 마신 일수 (오늘 기준)</div>
      <div class="stats-line" id="coffee-streak">커피 안 마신 날: -일</div>
      <div class="stats-line" id="alcohol-streak">술 안 마신 날: -일</div>

      <div class="stats-group-title">이번 달 요약</div>
      <div class="stats-line" id="coffee-month">커피 마신 날: -일</div>
      <div class="stats-line" id="alcohol-month">술 마신 날: -일</div>
    </div>

    <div class="tip">
Tip
- 윗쪽에 사용자 이름을 적고 적용하면, 그 사람 전용 달력이 됩니다.
- 날짜 칸에서 ‘○ 커피 / ● 술’ 을 클릭해 기록해요.
- 술 마신 날: 연한 빨강 / 커피 마신 날: 주황 / 둘 다 안 마심: 연한 파랑
    </div>
  </div>
  <!-- 여기까지가 HTML 본문 -->

  <script>
    // ==== 전역 상태 ====
    let currentUser = "default";
    let currentYear;
    let currentMonth; // 1~12
    let monthData = {}; // { "YYYY-MM-DD": { coffee: "마셨다", ... } }
    let statsData = {};

    // 오늘 기준 초기값
    const today = new Date();
    currentYear = today.getFullYear();
    currentMonth = today.getMonth() + 1;

    // ==== DOM 참조 ====
    const usernameInput = document.getElementById("username-input");
    const userApplyBtn = document.getElementById("user-apply-btn");
    const todayBtn = document.getElementById("today-btn");
    const prevMonthBtn = document.getElementById("prev-month-btn");
    const nextMonthBtn = document.getElementById("next-month-btn");
    const monthTitle = document.getElementById("month-title");
    const calendarGrid = document.getElementById("calendar-grid");

    const coffeeStreakEl = document.getElementById("coffee-streak");
    const alcoholStreakEl = document.getElementById("alcohol-streak");
    const coffeeMonthEl = document.getElementById("coffee-month");
    const alcoholMonthEl = document.getElementById("alcohol-month");

    // ==== 유틸 ====
    function pad2(n) {
      return n < 10 ? "0" + n : "" + n;
    }

    function getDateStr(y, m, d) {
      return `${y}-${pad2(m)}-${pad2(d)}`;
    }

    function toKoreanMonth(y, m) {
      return `${y}년 ${m}월`;
    }

    // Monday-based weekday index 변환
    function weekdayIndexMonStart(jsDay) {
      // JS: 0=Sun,1=Mon,...6=Sat → Mon=0 ... Sun=6
      return (jsDay + 6) % 7;
    }

    // ==== API 호출 ====
    async function fetchMonthData() {
      const user = currentUser || "default";
      const url = `/api/month?user=${encodeURIComponent(user)}&year=${currentYear}&month=${currentMonth}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.error) {
        alert(data.error);
        return;
      }
      monthData = data.days || {};
      statsData = data.stats || {};
      renderCalendar();
      renderStats();
    }

    async function updateDay(dateStr, key, newOn) {
      const body = {
        user: currentUser || "default",
        date: dateStr,
      };
      if (key === "coffee") {
        body.coffee = newOn;
      } else if (key === "alcohol") {
        body.alcohol = newOn;
      }

      const res = await fetch("/api/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (data.error) {
        alert(data.error);
        return;
      }

      await fetchMonthData();
    }

    // ==== 렌더링 ====
    function renderStats() {
      coffeeStreakEl.textContent = `커피 안 마신 날: ${statsData.coffee_streak ?? "-"}일`;
      alcoholStreakEl.textContent = `술 안 마신 날: ${statsData.alcohol_streak ?? "-"}일`;
      coffeeMonthEl.textContent = `커피 마신 날: ${statsData.coffee_month ?? "-"}일`;
      alcoholMonthEl.textContent = `술 마신 날: ${statsData.alcohol_month ?? "-"}일`;
    }

    function renderCalendar() {
      monthTitle.textContent = toKoreanMonth(currentYear, currentMonth);
      calendarGrid.innerHTML = "";

      const firstDate = new Date(currentYear, currentMonth - 1, 1);
      const lastDate = new Date(currentYear, currentMonth, 0);
      const daysInMonth = lastDate.getDate();

      const firstWeekday = weekdayIndexMonStart(firstDate.getDay()); // 0=월

      // 앞쪽 빈 칸
      for (let i = 0; i < firstWeekday; i++) {
        const emptyCell = document.createElement("div");
        calendarGrid.appendChild(emptyCell);
      }

      // 날짜 칸
      for (let d = 1; d <= daysInMonth; d++) {
        const cellDate = new Date(currentYear, currentMonth - 1, d);
        const dateStr = getDateStr(currentYear, currentMonth, d);

        const dayData = monthData[dateStr] || {};
        const coffeeOn = dayData.coffee === "마셨다";
        const alcoholOn = dayData.alcohol === "마셨다";

        // 배경색 결정
        let bgColor = "#e0f2fe"; // 둘 다 안 마심
        if (alcoholOn) {
          bgColor = "#fecaca";  // 술 마심
        } else if (coffeeOn) {
          bgColor = "#fed7aa";  // 커피 마심
        }

        const outer = document.createElement("div");
        outer.className = "day-cell-outer";

        const inner = document.createElement("div");
        inner.className = "day-cell-inner";
        inner.style.backgroundColor = bgColor;

        // 오늘 날짜 테두리
        const isToday =
          cellDate.getFullYear() === today.getFullYear() &&
          cellDate.getMonth() === today.getMonth() &&
          cellDate.getDate() === today.getDate();

        if (isToday) inner.classList.add("today");

        // 숫자
        const dayNumber = document.createElement("div");
        dayNumber.className = "day-number";
        dayNumber.textContent = String(d);

        // 토글 UI
        const toggles = document.createElement("div");
        toggles.className = "toggles-container";

        function createToggleLine(labelText, isOn, onColor, key) {
          const line = document.createElement("div");
          line.className = "toggle-line";

          const circle = document.createElement("span");
          circle.textContent = isOn ? "●" : "○";
          circle.style.color = isOn ? onColor : "#9ca3af";

          const text = document.createElement("span");
          text.textContent = labelText;

          line.appendChild(circle);
          line.appendChild(text);

          line.addEventListener("click", () => {
            const newOnState = !isOn;
            updateDay(dateStr, key, newOnState);
          });

          return line;
        }

        const coffeeLine = createToggleLine("커피", coffeeOn, "#f97316", "coffee");
        const alcoholLine = createToggleLine("술", alcoholOn, "#dc2626", "alcohol");

        toggles.appendChild(coffeeLine);
        toggles.appendChild(alcoholLine);

        // 조립
        inner.appendChild(dayNumber);
        inner.appendChild(toggles);

        outer.appendChild(inner);
        calendarGrid.appendChild(outer);
      }
    }

    // ==== 이벤트 연결 ====
    userApplyBtn.addEventListener("click", () => {
      const name = usernameInput.value.trim();
      currentUser = name || "default";
      localStorage.setItem("sul_calendar_user", currentUser);
      fetchMonthData();
    });

    todayBtn.addEventListener("click", () => {
      const now = new Date();
      currentYear = now.getFullYear();
      currentMonth = now.getMonth() + 1;
      fetchMonthData();
    });

    prevMonthBtn.addEventListener("click", () => {
      currentMonth -= 1;
      if (currentMonth === 0) {
        currentMonth = 12;
        currentYear -= 1;
      }
      fetchMonthData();
    });

    nextMonthBtn.addEventListener("click", () => {
      currentMonth += 1;
      if (currentMonth === 13) {
        currentMonth = 1;
        currentYear += 1;
      }
      fetchMonthData();
    });

    // 저장된 유저 자동 로드
    const savedUser = localStorage.getItem("sul_calendar_user");
    if (savedUser) {
      currentUser = savedUser;
      usernameInput.value = savedUser === "default" ? "" : savedUser;
    }

    // 첫 로딩
    fetchMonthData();
  </script>
</body>
</html>
