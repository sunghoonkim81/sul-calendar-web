<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>술달력 웹버전</title>
  <style>
    body {
      margin: 0;
      font-family: "맑은 고딕", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f3f4f6;
      color: #111827;
    }
    .app-container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }
    .header {
      background-color: #111827;
      color: #f9fafb;
      padding: 16px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-title {
      font-size: 22px;
      font-weight: bold;
      color: #f87171;
    }
    .user-input {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 16px;
    }
    .user-input input {
      border-radius: 9999px;
      border: none;
      padding: 6px 12px;
      font-size: 13px;
    }
    .header button {
      border: none;
      padding: 6px 12px;
      border-radius: 9999px;
      background-color: #374151;
      color: #f9fafb;
      cursor: pointer;
      font-size: 12px;
    }
    .header button:hover {
      background-color: #4b5563;
    }

    .calendar-card {
      background-color: #ffffff;
      border-radius: 12px;
      margin-top: 12px;
      padding: 12px 16px 16px;
      box-shadow: 0 10px 15px -3px rgba(15, 23, 42, 0.1),
                  0 4px 6px -4px rgba(15, 23, 42, 0.1);
    }

    .calendar-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      margin-bottom: 8px;
      font-size: 18px;
      font-weight: bold;
    }
    .calendar-header button {
      border: none;
      background: #e5e7eb;
      border-radius: 9999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      margin-top: 8px;
      font-size: 13px;
      font-weight: bold;
      color: #6b7280;
      text-align: center;
    }
    .weekdays .sat { color: #3b82f6; }
    .weekdays .sun { color: #ef4444; }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 6px;
      margin-top: 10px;
    }

    .day-cell-outer {
      background-color: #f9fafb;
      border-radius: 10px;
      padding: 2px;
    }
    .day-cell-inner {
      background-color: #f9fafb;
      border-radius: 8px;
      min-height: 70px;
      display: flex;
      flex-direction: column;
      padding: 4px;
      box-sizing: border-box;
      transition: background-color 0.15s ease, box-shadow 0.15s ease;
    }
    .day-cell-inner.today {
      box-shadow: 0 0 0 2px #2563eb;
    }
    .day-number {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .toggles-container {
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .toggle-line {
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .stats-card, .rank-card {
      background: white;
      padding: 12px;
      border-radius: 12px;
      margin-top: 12px;
      border: 1px solid #e5e7eb;
    }
    .stats-title {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 6px;
    }
    .stats-group-title {
      margin-top: 10px;
      font-size: 14px;
      font-weight: bold;
    }
    .stats-line {
      font-size: 13px;
      margin: 2px 0;
    }
    .rank-title {
      font-size: 16px;
      font-weight: bold;
    }
    .rank-item {
      font-size: 13px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- HEADER -->
    <div class="header">
      <div class="header-title">술달력 웹버전</div>

      <div class="user-input">
        사용자 이름:
        <input id="username-input" type="text" placeholder="예: 홍길동" />
        <button id="user-apply-btn">적용</button>
      </div>

      <div style="flex:1"></div>
      <button id="today-btn">오늘로</button>
    </div>

    <!-- CALENDAR -->
    <div class="calendar-card">
      <div class="calendar-header">
        <button id="prev-month-btn">◀</button>
        <div id="month-title"></div>
        <button id="next-month-btn">▶</button>
      </div>

      <div class="weekdays">
        <div>월</div><div>화</div><div>수</div><div>목</div>
        <div>금</div><div class="sat">토</div><div class="sun">일</div>
      </div>

      <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <!-- 통계 -->
    <div class="stats-card">
      <div class="stats-title">통계</div>

      <div class="stats-group-title">연속으로 안 마신 일수 (오늘 기준)</div>
      <div class="stats-line" id="coffee-streak">커피 안 마신 날: -일</div>
      <div class="stats-line" id="alcohol-streak">술 안 마신 날: -일</div>

      <div class="stats-group-title">이번 달 요약</div>
      <div class="stats-line" id="coffee-month">커피 마신 날: -일</div>
      <div class="stats-line" id="alcohol-month">술 마신 날: -일</div>
    </div>

    <!-- 순위 -->
    <div class="rank-card">
      <div class="rank-title">전체 사용자 순위 (이번 달)</div>

      <div class="stats-group-title">커피 많이 마신 순위</div>
      <div id="coffee-rank-list"></div>

      <div class="stats-group-title">술 많이 마신 순위</div>
      <div id="alcohol-rank-list"></div>
    </div>

    <script>
      // ===== 상태 =====
      let currentUser = "default";
      let currentYear;
      let currentMonth;
      let monthData = {};
      let statsData = {};

      const today = new Date();
      currentYear = today.getFullYear();
      currentMonth = today.getMonth() + 1;

      // DOM
      const usernameInput = document.getElementById("username-input");
      const userApplyBtn = document.getElementById("user-apply-btn");
      const todayBtn = document.getElementById("today-btn");
      const prevBtn = document.getElementById("prev-month-btn");
      const nextBtn = document.getElementById("next-month-btn");
      const monthTitle = document.getElementById("month-title");
      const calendarGrid = document.getElementById("calendar-grid");

      const coffeeStreakEl = document.getElementById("coffee-streak");
      const alcoholStreakEl = document.getElementById("alcohol-streak");
      const coffeeMonthEl = document.getElementById("coffee-month");
      const alcoholMonthEl = document.getElementById("alcohol-month");

      const coffeeRankList = document.getElementById("coffee-rank-list");
      const alcoholRankList = document.getElementById("alcohol-rank-list");

      const pad = (n) => (n < 10 ? "0" + n : "" + n);
      const getDateStr = (y, m, d) => `${y}-${pad(m)}-${pad(d)}`;
      const weekdayMon = (jsDay) => (jsDay + 6) % 7; // Sun=0 → Mon=0

      // ---- API ----
      async function fetchMonthData() {
        const url = `/api/month?user=${encodeURIComponent(currentUser)}&year=${currentYear}&month=${currentMonth}`;
        const res = await fetch(url);
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        monthData = data.days || {};
        statsData = data.stats || {};

        renderCalendar();
        renderStats();
        renderRanks();
      }

      async function updateDay(dateStr, key, newOn) {
        const body = { user: currentUser, date: dateStr };
        if (key === "coffee") body.coffee = newOn;
        if (key === "alcohol") body.alcohol = newOn;

        await fetch("/api/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        fetchMonthData();
      }

      // ---- 렌더: 통계 ----
      function renderStats() {
        coffeeStreakEl.textContent =
          `커피 안 마신 날: ${statsData.coffee_streak ?? "-"}일`;
        alcoholStreakEl.textContent =
          `술 안 마신 날: ${statsData.alcohol_streak ?? "-"}일`;
        coffeeMonthEl.textContent =
          `커피 마신 날: ${statsData.coffee_month ?? "-"}일`;
        alcoholMonthEl.textContent =
          `술 마신 날: ${statsData.alcohol_month ?? "-"}일`;
      }

      // ---- 렌더: 순위 ----
      function renderRanks() {
        const coffeeRank = statsData.coffee_rank || [];
        const alcoholRank = statsData.alcohol_rank || [];

        coffeeRankList.innerHTML = "";
        alcoholRankList.innerHTML = "";

        if (coffeeRank.length === 0) {
          coffeeRankList.innerHTML = "<div class='rank-item'>데이터 없음</div>";
        } else {
          coffeeRank.forEach((item, idx) => {
            const div = document.createElement("div");
            div.className = "rank-item";
            div.textContent = `${idx + 1}위: ${item[0]} (${item[1]}일 마심)`;
            coffeeRankList.appendChild(div);
          });
        }

        if (alcoholRank.length === 0) {
          alcoholRankList.innerHTML = "<div class='rank-item'>데이터 없음</div>";
        } else {
          alcoholRank.forEach((item, idx) => {
            const div = document.createElement("div");
            div.className = "rank-item";
            div.textContent = `${idx + 1}위: ${item[0]} (${item[1]}일 마심)`;
            alcoholRankList.appendChild(div);
          });
        }
      }

      // ---- 렌더: 달력 ----
      function renderCalendar() {
        monthTitle.textContent = `${currentYear}년 ${currentMonth}월`;
        calendarGrid.innerHTML = "";

        const firstDate = new Date(currentYear, currentMonth - 1, 1);
        const lastDate = new Date(currentYear, currentMonth, 0);
        const daysInMonth = lastDate.getDate();

        const firstWeekday = weekdayMon(firstDate.getDay());

        // 앞쪽 빈 칸
        for (let i = 0; i < firstWeekday; i++) {
          calendarGrid.appendChild(document.createElement("div"));
        }

        for (let d = 1; d <= daysInMonth; d++) {
          const dateStr = getDateStr(currentYear, currentMonth, d);
          const jsDate = new Date(currentYear, currentMonth - 1, d);

          const dayData = monthData[dateStr] || {};
          const coffeeOn = dayData.coffee === "마셨다";
          const alcoholOn = dayData.alcohol === "마셨다";

          let bg = "#e0f2fe";        // 둘 다 안 마심
          if (alcoholOn) bg = "#fecaca";      // 술
          else if (coffeeOn) bg = "#fed7aa";  // 커피

          const outer = document.createElement("div");
          outer.className = "day-cell-outer";

          const inner = document.createElement("div");
          inner.className = "day-cell-inner";
          inner.style.backgroundColor = bg;

          if (
            jsDate.getFullYear() === today.getFullYear() &&
            jsDate.getMonth() === today.getMonth() &&
            jsDate.getDate() === today.getDate()
          ) {
            inner.classList.add("today");
          }

          const dayNumber = document.createElement("div");
          dayNumber.className = "day-number";
          dayNumber.textContent = String(d);

          const toggles = document.createElement("div");
          toggles.className = "toggles-container";

          function makeToggle(label, isOn, color, key) {
            const line = document.createElement("div");
            line.className = "toggle-line";
            const circle = document.createElement("span");
            circle.textContent = isOn ? "●" : "○";
            circle.style.color = isOn ? color : "#9ca3af";
            const txt = document.createElement("span");
            txt.textContent = label;
            line.appendChild(circle);
            line.appendChild(txt);
            line.onclick = () => updateDay(dateStr, key, !isOn);
            return line;
          }

          toggles.appendChild(makeToggle("커피", coffeeOn, "#f97316", "coffee"));
          toggles.appendChild(makeToggle("술", alcoholOn, "#dc2626", "alcohol"));

          inner.appendChild(dayNumber);
          inner.appendChild(toggles);
          outer.appendChild(inner);
          calendarGrid.appendChild(outer);
        }
      }

      // ---- 이벤트 ----
      userApplyBtn.onclick = () => {
        const name = usernameInput.value.trim();
        currentUser = name || "default";
        localStorage.setItem("sul_calendar_user", currentUser);
        fetchMonthData();
      };

      todayBtn.onclick = () => {
        const now = new Date();
        currentYear = now.getFullYear();
        currentMonth = now.getMonth() + 1;
        fetchMonthData();
      };

      prevBtn.onclick = () => {
        currentMonth--;
        if (currentMonth === 0) {
          currentMonth = 12;
          currentYear--;
        }
        fetchMonthData();
      };

      nextBtn.onclick = () => {
        currentMonth++;
        if (currentMonth === 13) {
          currentMonth = 1;
          currentYear++;
        }
        fetchMonthData();
      };

      // 저장된 사용자 이름 복원
      const savedUser = localStorage.getItem("sul_calendar_user");
      if (savedUser) {
        currentUser = savedUser;
        usernameInput.value = savedUser === "default" ? "" : savedUser;
      }

      // 첫 로딩
      fetchMonthData();
    </script>
  </div>
</body>
</html>
